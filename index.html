<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Stundenformular</title>

<style>
:root{
  --bg:#f4f6ff;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
  --border:#e2e8f0;
  --danger:#ef4444;
  --accent:#4f46e5;
  --accent2:#06b6d4;
  --shadow: 0 12px 28px rgba(0,0,0,.10);
}
*{ box-sizing:border-box; }
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:linear-gradient(180deg, #eef2ff 0%, var(--bg) 40%);
  color:var(--text);
}
.wrap{ max-width:560px; margin:0 auto; padding:12px; }

/* Topbar */
.topbar{
  position:sticky;
  top:10px;
  z-index:60;
  background:linear-gradient(135deg, rgba(79,70,229,.12), rgba(6,182,212,.10));
  border:1px solid rgba(226,232,240,.9);
  border-radius:18px;
  padding:10px;
  box-shadow:var(--shadow);
  backdrop-filter: blur(6px);
}
.btnrow{
  display:grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap:8px;
}
button{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid var(--border);
  font-weight:900;
  font-size:15px;
  cursor:pointer;
  background:#fff;
}
button.primary{
  background:linear-gradient(135deg, #111827, #1f2937);
  color:#fff;
  border-color:#111827;
}
button.danger{
  color:var(--danger);
  border-color:rgba(239,68,68,.55);
  background:#fff;
}

/* Card */
.card{
  margin-top:10px;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:14px;
  box-shadow:0 8px 18px rgba(0,0,0,.06);
}

/* NEU: Kopfbereich deutlicher absetzen */
.card.headerCard{
  background:linear-gradient(135deg, rgba(79,70,229,.12), rgba(6,182,212,.10));
  border:1px solid rgba(79,70,229,.18);
  box-shadow:0 10px 22px rgba(0,0,0,.08);
}

label{ font-weight:900; }
input, select{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid var(--border);
  font-size:16px;
  background:#fff;
}
.grid2{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.small{ font-size:12px; color:var(--muted); margin-top:6px; }

/* Day rows */
.row{
  margin-top:10px;
  background:#fff;
  border:1px solid var(--border);
  border-radius:18px;
  padding:12px;
  box-shadow:0 6px 16px rgba(0,0,0,.05);
  position:relative;
  overflow:hidden;
}
.row::before{
  content:"";
  position:absolute;
  left:0; top:0; bottom:0;
  width:6px;
  background:linear-gradient(180deg, var(--accent), var(--accent2));
}
.rowInner{ padding-left:6px; }

.date{ font-weight:1000; font-size:16px; margin-bottom:8px; }

.timelabels{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
  font-size:13px;
  font-weight:800;
  color:var(--muted);
  margin:6px 2px 6px;
}
.timelabels span{ text-align:center; }

.timewrap{
  display:grid;
  grid-template-columns:1fr auto 1fr;
  gap:8px;
  align-items:center;
}
.dash{ font-weight:1000; color:var(--muted); text-align:center; }

.hours{
  text-align:right;
  font-weight:900;
  background:#f8fafc;
}

/* Total */
.total{
  margin-top:12px;
  background:#fff;
  border:1px solid var(--border);
  border-radius:18px;
  padding:14px;
  font-size:22px;
  font-weight:1000;
  text-align:center;
  box-shadow:0 -10px 22px rgba(0,0,0,.06);
}

/* Preview modal */
.modalBack{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.45);
  z-index:200;
  padding:14px;
}
.modal{
  max-width:900px;
  margin:0 auto;
  background:#fff;
  border-radius:18px;
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  overflow:hidden;
}
.modalTop{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  padding:12px;
  background:linear-gradient(135deg, rgba(79,70,229,.10), rgba(6,182,212,.08));
  border-bottom:1px solid var(--border);
}
.modalBody{
  padding:12px;
  max-height:70vh;
  overflow:auto;
}
.modalBtns{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
  padding:12px;
  border-top:1px solid var(--border);
}

/* PRINT: 1 Seite (kompakt) */
@page{ size:A4 landscape; margin:4mm; }
#printArea{ display:none; }

@media print{
  body{ background:#fff; }
  .topbar, .card, .total, #rows, .modalBack{ display:none !important; }
  .wrap{ max-width:100% !important; padding:0 !important; }
  #printArea{ display:block !important; }

  #printTitle{ font-size:12pt; font-weight:1000; margin:0 0 2mm 0; }
  #printMeta{ font-size:9pt; margin:0 0 2mm 0; }

  table{
    width:100%;
    border-collapse:collapse;
    table-layout:fixed;
    font-size:10pt;
    line-height:1.12;
  }
  th, td{
    border:1px solid #111;
    padding:3px 5px;
    vertical-align:middle;
    overflow:hidden;
    white-space:nowrap;
    text-overflow:ellipsis;
  }
  th{ background:#eaeaea; font-weight:900; }
  .right{ text-align:right; }
  .empty td{ background:#f3f4f6; }
  tr{ page-break-inside:avoid; }
}
</style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div class="btnrow">
      <button class="primary" id="pdfBtn" type="button">PDF Export</button>
      <button id="prevBtn" type="button">PDF Vorschau</button>
      <button class="danger" id="delBtn" type="button">Alles löschen</button>
    </div>
  </div>

  <!-- Kopf-Bereich farblich abgesetzt -->
  <div class="card headerCard">
    <div>
      <label>Name:</label>
      <input id="name" placeholder="Bitte hier deinen Namen eintragen">
    </div>

    <div style="margin-top:10px;">
      <label>Monat / Jahr</label>
      <div class="grid2" style="margin-top:6px;">
        <select id="month"></select>
        <select id="year"></select>
      </div>
    </div>
  </div>

  <div id="rows"></div>

  <div class="total">
    Gesamtstunden: <span id="sum">0.00</span>
  </div>

  <!-- Vorschau -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalTop">
        <b id="previewTitle">PDF Vorschau</b>
        <button type="button" id="closePrevTop" style="width:auto; padding:10px 12px;">Schließen</button>
      </div>
      <div class="modalBody">
        <div id="previewMeta" class="small" style="margin-bottom:10px;"></div>
        <div id="previewTable"></div>
      </div>
      <div class="modalBtns">
        <button class="primary" type="button" id="exportFromPreview">PDF Export</button>
        <button type="button" id="closePrevBottom">Zurück</button>
      </div>
    </div>
  </div>

  <!-- Print -->
  <div id="printArea">
    <div id="printTitle"></div>
    <div id="printMeta"></div>

    <table>
      <thead>
        <tr>
          <th style="width:8%;">Tag</th>
          <th style="width:44%;">Einsatzort</th>
          <th style="width:16%;">Beginn</th>
          <th style="width:16%;">Ende</th>
          <th class="right" style="width:16%;">Stunden</th>
        </tr>
      </thead>
      <tbody id="printBody"></tbody>
      <tfoot>
        <tr>
          <th colspan="4" class="right">Gesamt</th>
          <th class="right" id="printTotal"></th>
        </tr>
      </tfoot>
    </table>
  </div>

</div>

<script>
const ORTE = ["Niendorf Nord","Hagenbecks Tierpark","Farmsen","Ochsenzoll"];
const STORAGE_PREFIX = "sad_stundenformular_v10:";

const nameEl = document.getElementById("name");
const monthEl = document.getElementById("month");
const yearEl  = document.getElementById("year");
const rowsEl  = document.getElementById("rows");
const sumEl   = document.getElementById("sum");

const pdfBtn  = document.getElementById("pdfBtn");
const prevBtn = document.getElementById("prevBtn");
const delBtn  = document.getElementById("delBtn");

const modalBack = document.getElementById("modalBack");
const previewTitle = document.getElementById("previewTitle");
const previewMeta  = document.getElementById("previewMeta");
const previewTable = document.getElementById("previewTable");
const closePrevTop = document.getElementById("closePrevTop");
const closePrevBottom = document.getElementById("closePrevBottom");
const exportFromPreview = document.getElementById("exportFromPreview");

const printTitleEl = document.getElementById("printTitle");
const printMetaEl  = document.getElementById("printMeta");
const printBodyEl  = document.getElementById("printBody");
const printTotalEl = document.getElementById("printTotal");

let current = new Date(); current.setDate(1);
let dirty = false;
let exported = false;

function pad2(n){ return String(n).padStart(2,"0"); }
function ymKey(d){ return d.getFullYear() + "-" + pad2(d.getMonth()+1); }
function storageKey(){ return STORAGE_PREFIX + ymKey(current); }
function daysInMonth(m,y){ return new Date(y, m, 0).getDate(); }

function markDirty(){
  dirty=true;
  exported=false;
  pdfBtn.disabled=false;
}

function fillMonthYear(){
  monthEl.innerHTML="";
  yearEl.innerHTML="";

  for(let i=1;i<=12;i++){
    const o=document.createElement("option");
    o.value=String(i);
    o.textContent=pad2(i);
    monthEl.appendChild(o);
  }

  const nowY=new Date().getFullYear();
  for(let i=nowY-3;i<=nowY+6;i++){
    const o=document.createElement("option");
    o.value=String(i);
    o.textContent=String(i);
    yearEl.appendChild(o);
  }

  monthEl.value=String(current.getMonth()+1);
  yearEl.value=String(current.getFullYear());
}

function build(){
  fillMonthYear();

  const m=parseInt(monthEl.value,10);
  const y=parseInt(yearEl.value,10);
  const days=daysInMonth(m,y);

  rowsEl.innerHTML="";

  for(let d=1; d<=days; d++){
    const row=document.createElement("div");
    row.className="row";
    row.dataset.day=String(d);

    row.innerHTML=`
      <div class="rowInner">
        <div class="date">${pad2(d)}.${pad2(m)}.${y}</div>

        <select class="ort">
          <option value="" selected disabled>Standort wählen</option>
          ${ORTE.map(o=>`<option value="${o}">${o}</option>`).join("")}
        </select>

        <div class="timelabels"><span>von</span><span>bis</span></div>

        <div class="timewrap">
          <input type="time" class="start">
          <div class="dash">–</div>
          <input type="time" class="end">
        </div>

        <div style="height:8px"></div>

        <input type="text" class="hours" placeholder="Stunden" readonly>
      </div>
    `;

    const ort=row.querySelector(".ort");
    const start=row.querySelector(".start");
    const end=row.querySelector(".end");
    const hours=row.querySelector(".hours");

    ort.addEventListener("change", ()=>{ markDirty(); saveState(); });
    start.addEventListener("change", ()=>{ autoHours(row); markDirty(); saveState(); });
    end.addEventListener("change", ()=>{ autoHours(row); markDirty(); saveState(); });

    hours.addEventListener("focus",(e)=>e.target.blur());

    rowsEl.appendChild(row);
  }

  loadState();
  updateTotal();

  if(exported && !dirty) pdfBtn.disabled=true;
}

function applyMonthAuto(){
  const mm=parseInt(monthEl.value,10);
  const yy=parseInt(yearEl.value,10);
  current=new Date(yy, mm-1, 1);
  dirty=false;
  exported=false;
  build();
}

function timeToMinutes(t){
  if(!t) return null;
  const m=t.match(/^(\d{2}):(\d{2})$/);
  if(!m) return null;
  const hh=parseInt(m[1],10), mm=parseInt(m[2],10);
  if(hh>23 || mm>59) return null;
  return hh*60 + mm;
}

function autoHours(row){
  const s=timeToMinutes(row.querySelector(".start").value);
  const e=timeToMinutes(row.querySelector(".end").value);
  const out=row.querySelector(".hours");

  if(s==null || e==null){
    out.value="";
    updateTotal();
    return;
  }
  let diff=e-s;
  if(diff<0) diff+=1440;
  out.value=(diff/60).toFixed(2);
  updateTotal();
}

function updateTotal(){
  let sum=0;
  document.querySelectorAll(".hours").forEach(i=>{
    const v=parseFloat(String(i.value).replace(",","."));
    if(!isNaN(v)) sum+=v;
  });
  sumEl.textContent=sum.toFixed(2);
}

function getState(){
  const rows=[];
  document.querySelectorAll("#rows .row").forEach(r=>{
    rows.push({
      day:r.dataset.day,
      ort:r.querySelector(".ort").value||"",
      start:r.querySelector(".start").value||"",
      end:r.querySelector(".end").value||"",
      hours:r.querySelector(".hours").value||""
    });
  });
  return {
    name:nameEl.value||"",
    monthKey:ymKey(current),
    rows,
    dirty,
    exported
  };
}

function saveState(){
  localStorage.setItem(storageKey(), JSON.stringify(getState()));
}

function loadState(){
  const raw=localStorage.getItem(storageKey());
  if(!raw){ saveState(); return; }

  try{
    const st=JSON.parse(raw);
    nameEl.value=st.name||"";

    const rowEls=document.querySelectorAll("#rows .row");
    (st.rows||[]).forEach((r, idx)=>{
      if(!rowEls[idx]) return;
      const ortSel=rowEls[idx].querySelector(".ort");
      if(r.ort) ortSel.value=r.ort; else ortSel.selectedIndex=0;

      rowEls[idx].querySelector(".start").value=r.start||"";
      rowEls[idx].querySelector(".end").value=r.end||"";
      rowEls[idx].querySelector(".hours").value=r.hours||"";
    });

    dirty=!!st.dirty;
    exported=!!st.exported;
  }catch(e){
    saveState();
  }
}

function buildPrintTable(){
  const name=(nameEl.value||"").trim();
  const mm=pad2(current.getMonth()+1);
  const yy=current.getFullYear();

  printTitleEl.textContent=`Stundenformular – ${mm}/${yy}`+(name?` – ${name}`:"");
  printMetaEl.textContent=`Gesamtstunden: ${sumEl.textContent}`;

  printBodyEl.innerHTML="";
  let sum=0;

  document.querySelectorAll("#rows .row").forEach(r=>{
    const day=r.dataset.day;
    const ort=r.querySelector(".ort").value||"";
    const start=r.querySelector(".start").value||"";
    const end=r.querySelector(".end").value||"";
    const hrs=r.querySelector(".hours").value||"";
    const empty=!ort&&!start&&!end&&!hrs;

    const tr=document.createElement("tr");
    if(empty) tr.className="empty";
    tr.innerHTML=`
      <td>${pad2(day)}</td>
      <td>${ort}</td>
      <td>${start}</td>
      <td>${end}</td>
      <td class="right">${hrs}</td>
    `;
    printBodyEl.appendChild(tr);

    const v=parseFloat(String(hrs).replace(",","."));
    if(!isNaN(v)) sum+=v;
  });

  printTotalEl.textContent=sum.toFixed(2);
}

function exportPDF(){
  buildPrintTable();
  exported=true;
  dirty=false;
  pdfBtn.disabled=true;
  saveState();
  window.print();
}

function allesLoeschen(){
  if(!confirm("Wirklich ALLES für diesen Monat löschen?")) return;
  localStorage.removeItem(storageKey());
  dirty=false;
  exported=false;
  build();
}

/*** Vorschau ***/
function openPreview(){
  const name=(nameEl.value||"").trim();
  const mm=pad2(current.getMonth()+1);
  const yy=current.getFullYear();

  previewTitle.textContent=`PDF Vorschau – ${mm}/${yy}`+(name?` – ${name}`:"");
  previewMeta.textContent=`Gesamtstunden: ${sumEl.textContent}`;

  const parts=[];
  parts.push(`
    <table style="width:100%; border-collapse:collapse; table-layout:fixed; font-size:11px;">
      <thead>
        <tr>
          <th style="border:1px solid #ddd; padding:6px; width:10%;">Tag</th>
          <th style="border:1px solid #ddd; padding:6px; width:42%;">Einsatzort</th>
          <th style="border:1px solid #ddd; padding:6px; width:16%;">Beginn</th>
          <th style="border:1px solid #ddd; padding:6px; width:16%;">Ende</th>
          <th style="border:1px solid #ddd; padding:6px; width:16%; text-align:right;">Stunden</th>
        </tr>
      </thead>
      <tbody>
  `);

  document.querySelectorAll("#rows .row").forEach(r=>{
    const day=r.dataset.day;
    const ort=r.querySelector(".ort").value||"";
    const start=r.querySelector(".start").value||"";
    const end=r.querySelector(".end").value||"";
    const hrs=r.querySelector(".hours").value||"";
    const empty=!ort&&!start&&!end&&!hrs;

    parts.push(`
      <tr style="${empty ? "background:#f3f4f6;" : ""}">
        <td style="border:1px solid #ddd; padding:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${pad2(day)}</td>
        <td style="border:1px solid #ddd; padding:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${ort}</td>
        <td style="border:1px solid #ddd; padding:6px; white-space:nowrap;">${start}</td>
        <td style="border:1px solid #ddd; padding:6px; white-space:nowrap;">${end}</td>
        <td style="border:1px solid #ddd; padding:6px; text-align:right; white-space:nowrap;">${hrs}</td>
      </tr>
    `);
  });

  parts.push(`</tbody></table>`);
  previewTable.innerHTML=parts.join("");
  modalBack.style.display="block";
}
function closePreview(){ modalBack.style.display="none"; }

/*** EVENTS ***/
pdfBtn.addEventListener("click", exportPDF);
prevBtn.addEventListener("click", openPreview);
delBtn.addEventListener("click", allesLoeschen);

closePrevTop.addEventListener("click", closePreview);
closePrevBottom.addEventListener("click", closePreview);
exportFromPreview.addEventListener("click", exportPDF);

modalBack.addEventListener("click",(e)=>{ if(e.target===modalBack) closePreview(); });

monthEl.addEventListener("change", applyMonthAuto);
yearEl.addEventListener("change", applyMonthAuto);
nameEl.addEventListener("input", ()=>{ markDirty(); saveState(); });

/*** START ***/
fillMonthYear();
build();
</script>
</body>
</html>
