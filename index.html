<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Stundenformular</title>

<style>
:root{
  --bg:#f4f6ff;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
  --border:#e2e8f0;
  --danger:#ef4444;

  --accent:#4f46e5;
  --accent2:#06b6d4;
  --shadow: 0 12px 28px rgba(0,0,0,.10);

  --pinBg: none;
}

*{ box-sizing:border-box; }
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:linear-gradient(180deg, #eef2ff 0%, var(--bg) 40%);
  color:var(--text);
}
.wrap{ max-width:560px; margin:0 auto; padding:12px; }

.topbar{
  position:sticky;
  top:10px;
  z-index:60;
  background:linear-gradient(135deg, rgba(79,70,229,.12), rgba(6,182,212,.10));
  border:1px solid rgba(226,232,240,.9);
  border-radius:18px;
  padding:10px;
  box-shadow:var(--shadow);
  backdrop-filter: blur(6px);
}
.btnrow{
  display:grid;
  grid-template-columns: 1fr 1fr 1fr 1fr;
  gap:8px;
}
button{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid var(--border);
  font-weight:900;
  font-size:15px;
  cursor:pointer;
  background:#fff;
}
button.primary{
  background:linear-gradient(135deg, #111827, #1f2937);
  color:#fff;
  border-color:#111827;
}
button.danger{
  color:var(--danger);
  border-color:rgba(239,68,68,.55);
  background:#fff;
}
button.send{
  background:linear-gradient(135deg, rgba(79,70,229,.95), rgba(6,182,212,.90));
  color:#fff;
  border-color:rgba(79,70,229,.35);
}
button:disabled{ opacity:.55; cursor:not-allowed; }
.small{ font-size:12px; color:var(--muted); margin-top:6px; }

.card{
  margin-top:10px;
  background:linear-gradient(135deg, rgba(79,70,229,.18), rgba(6,182,212,.12));
  border:1px solid rgba(226,232,240,.95);
  border-radius:18px;
  padding:14px;
  box-shadow:0 8px 18px rgba(0,0,0,.06);
}
.cardDivider{
  height:2px;
  margin:12px 0 6px;
  background:linear-gradient(90deg, rgba(79,70,229,.55), rgba(6,182,212,.55));
  border-radius:999px;
  opacity:.7;
}
label{ font-weight:900; }
input, select{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid var(--border);
  font-size:16px;
  background:#fff;
}
.grid2{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }

.total{
  margin-top:12px;
  background:#fff;
  border:1px solid var(--border);
  border-radius:18px;
  padding:14px;
  font-size:22px;
  font-weight:1000;
  text-align:center;
  box-shadow:0 -10px 22px rgba(0,0,0,.06);
}

.tableCard{
  margin-top:10px;
  background:linear-gradient(135deg, rgba(79,70,229,.10), rgba(6,182,212,.08));
  border:1px solid rgba(226,232,240,.95);
  border-radius:18px;
  padding:12px;
  box-shadow:0 6px 16px rgba(0,0,0,.05);
}
.tableHeadRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:2px 2px 10px;
}
.tableHeadRow .title{
  font-weight:1000;
  font-size:16px;
}
.tableHeadRow .hint{
  color:var(--muted);
  font-weight:800;
  font-size:12px;
  white-space:nowrap;
}

.tableScroll{
  background:#fff;
  border:1px solid var(--border);
  border-radius:16px;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
}

.entryTable{
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;
  min-width: 620px;
}
.entryTable th{
  background: #ede9fe;
  color: #5b21b6;
  font-weight: 1000;
  font-size: 13px;
  padding: 9px 7px;
  border-bottom: 1px solid #c4b5fd;
}
.entryTable td{
  padding:9px 7px;
  border-bottom:1px solid var(--border);
  vertical-align:middle;
}

.entryTable th,
.entryTable td{
  border-right: 1px solid rgba(109,40,217,.08);
}
.entryTable th:last-child,
.entryTable td:last-child{
  border-right: none;
}
.entryTable td{
  border-bottom: 1px solid rgba(109,40,217,.06);
}

.entryTable select{
  width:100%;
  padding:9px 10px;
  border-radius:14px;
  border:1px solid var(--border);
  font-size:14px;
  background:#fff;
}

/* ===== EIN FELD + RESET IM FELD ===== */
.timeField{
  position:relative;
  width:100%;
}
.timeField input{
  width:100%;
  padding:9px 10px;
  border-radius:14px;
  border:1px solid var(--border);
  font-size:14px;
  background:#fff;
  color:#0f172a;
}
.timeField input::placeholder{ color:#0f172a; opacity:.55; }
/* =================================== */

.entryHours{
  width:100%;
  padding:9px 10px;
  border-radius:14px;
  border:1px solid var(--border);
  background:#f8fafc;
  font-weight:900;
  font-size:14px;
  text-align:center;
}
.right{ text-align:right; }

.colDay{ width:70px; }
.colKehre{ width:190px; }
.colTime{ width:120px; }
.colStd{ width:120px; }

.trActive td{
  background: linear-gradient(90deg, rgba(79,70,229,.08), rgba(6,182,212,.06));
}
.trActive td:first-child{
  box-shadow: inset 4px 0 0 rgba(79,70,229,.65);
}

@page{ size:A4 landscape; margin:3mm; }
#printArea{ display:none; }

@media print{
  body{ background:#fff; }
  .topbar, .card, .total, .tableCard, .modalBack, .pinBack, .dlgBack, .timeSheetBack{ display:none !important; }
  .wrap{ max-width:100% !important; padding:0 !important; }
  #printArea{ display:block !important; }

  #printArea{
    zoom: 0.92;
    transform: scale(0.92);
    transform-origin: top left;
    width: 108.7%;
  }

  #printTitle{ font-size:11pt; font-weight:1000; margin:0 0 1.5mm 0; }
  #printMetaTop{ font-size:8.5pt; margin:0 0 1.5mm 0; }
  #printMetaBottom{ font-size:8.5pt; margin:1.5mm 0 0 0; }

  table{
    width:100%;
    border-collapse:collapse;
    table-layout:fixed;
    font-size:9pt;
    line-height:1.02;
  }
  th, td{
    border:1px solid #111;
    padding:2px 4px;
    vertical-align:middle;
    overflow:hidden;
    white-space:nowrap;
    text-overflow:ellipsis;
  }
  th{ background:#eaeaea; font-weight:900; }
  thead{ display:table-header-group; }
  tfoot{ display:table-footer-group; }
  tr{ page-break-inside:avoid; }
  .right{ text-align:right; }
  .empty td{ background:#f3f4f6; }
}

.modalBack{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.45);
  z-index:200;
  padding:14px;
}
.modal{
  max-width:900px;
  margin:0 auto;
  background:#fff;
  border-radius:18px;
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  overflow:hidden;
}
.modalTop{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  padding:12px;
  background:linear-gradient(135deg, rgba(79,70,229,.10), rgba(6,182,212,.08));
  border-bottom:1px solid var(--border);
}
.modalBody{
  padding:12px;
  max-height:70vh;
  overflow:auto;
}
.modalBtns{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
  padding:12px;
  border-top:1px solid var(--border);
}

.pinBack{
  position:fixed;
  inset:0;
  z-index:999;
  display:none;
  align-items:center;
  justify-content:center;
  padding:16px;

  background:
    radial-gradient(1200px 600px at 30% 20%, rgba(79,70,229,.28), transparent 55%),
    radial-gradient(1000px 600px at 70% 80%, rgba(6,182,212,.22), transparent 55%),
    linear-gradient(rgba(0,0,0,0.72), rgba(0,0,0,0.78)),
    var(--pinBg);
  background-position:center;
  background-size:cover;
  background-repeat:no-repeat;
}
.pinCard{
  width:min(420px, 100%);
  border-radius:22px;
  padding:18px;

  background: rgba(255,255,255,0.10);
  border:1px solid rgba(255,255,255,0.18);
  box-shadow: 0 24px 60px rgba(0,0,0,.45);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  color:#fff;
}
.pinTitle{ font-weight:1000; font-size:20px; margin:0 0 6px; }
.pinHint{ color:rgba(255,255,255,.82); font-size:13px; margin:0 0 14px; line-height:1.25; }

.pinRow{ display:flex; gap:10px; align-items:center; }
.pinRow input{
  flex:1;
  padding:12px 14px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,0.16);
  background: rgba(15,23,42,.35);
  color:#fff;
  font-size:16px;
  outline:none;
}
.pinRow input::placeholder{ color: rgba(255,255,255,.55); }

.pinOk{
  width:auto;
  padding:12px 16px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,0.16);
  background: linear-gradient(135deg, rgba(79,70,229,.92), rgba(6,182,212,.88));
  color:#fff;
  font-weight:1000;
  cursor:pointer;
}
.pinError{
  margin-top:10px;
  font-weight:900;
  color:#fecaca;
  display:none;
}

.inputError{
  border-color: rgba(239,68,68,.92) !important;
  box-shadow: 0 0 0 3px rgba(239,68,68,.18);
}

.dlgBack{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.45);
  z-index:300;
  padding:14px;
}
.dlg{
  max-width:520px;
  margin:20vh auto 0;
  background:#fff;
  border-radius:18px;
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  overflow:hidden;
}
.dlgTop{
  padding:12px 14px;
  background:linear-gradient(135deg, rgba(79,70,229,.10), rgba(6,182,212,.08));
  border-bottom:1px solid var(--border);
  font-weight:1000;
}
.dlgBody{
  padding:14px;
  color:#0f172a;
  font-weight:800;
  line-height:1.3;
}
.dlgBtns{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
  padding:12px;
  border-top:1px solid var(--border);
}
.dlgBtns.one{
  grid-template-columns:1fr;
}
.dlgBtn{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid var(--border);
  font-weight:1000;
  font-size:15px;
  cursor:pointer;
  background:#fff;
}
.dlgBtn.primary{
  background:linear-gradient(135deg, rgba(79,70,229,.95), rgba(6,182,212,.90));
  color:#fff;
  border-color:rgba(79,70,229,.35);
}

/* ===== BOTTOM SHEET (A) ===== */
.timeSheetBack{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.45);
  z-index:400;
  padding:0;
}
.timeSheet{
  position:absolute;
  left:0; right:0; bottom:0;
  background:#fff;
  border-radius:18px 18px 0 0;
  border-top:1px solid var(--border);
  box-shadow:0 -18px 40px rgba(0,0,0,.18);
  padding:12px;
  max-height:70vh;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
}
.timeSheetTitle{
  font-weight:1000;
  font-size:18px;
  margin:4px 2px 10px;
}
.timeOpt{
  display:flex;
  align-items:center;
  gap:10px;
  padding:14px 10px;
  border-top:1px solid rgba(226,232,240,.85);
  font-weight:900;
  cursor:pointer;
}
.timeOpt:first-of-type{ border-top:none; }
.timeOpt .radio{
  width:18px; height:18px;
  border-radius:999px;
  border:2px solid rgba(15,23,42,.25);
  display:inline-block;
}
.timeOpt.active .radio{
  border-color: rgba(79,70,229,.95);
  box-shadow: inset 0 0 0 4px rgba(79,70,229,.95);
}
.timeSheetFooter{
  margin-top:12px;
  padding-top:12px;
  border-top:1px solid rgba(226,232,240,.85);
}
.timeSheetBtn{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid var(--border);
  font-weight:1000;
  font-size:15px;
  cursor:pointer;
  background:#fff;
}
.timeSheetBtn.primary{
  background:linear-gradient(135deg, rgba(79,70,229,.95), rgba(6,182,212,.90));
  color:#fff;
  border-color:rgba(79,70,229,.35);
}
.timeOpt.dangerOpt{
  color: var(--danger);
  font-weight:1000;
}
.timeOpt.dangerOpt .radio{
  border-color: rgba(239,68,68,.35);
}
.timeOpt.dangerOpt.active .radio{
  border-color: rgba(239,68,68,.9);
  box-shadow: inset 0 0 0 4px rgba(239,68,68,.9);
}
/* =========================== */
</style>
</head>

<body>

<!-- PIN Overlay -->
<div class="pinBack" id="pinBack">
  <div class="pinCard">
    <div class="pinTitle">PIN erforderlich</div>
    <p class="pinHint">Bitte PIN eingeben, um das Stundenformular zu öffnen.</p>
    <div class="pinRow">
      <input id="pinInput" inputmode="numeric" autocomplete="one-time-code" placeholder="PIN eingeben">
      <button class="pinOk" id="pinBtn" type="button">OK</button>
    </div>
    <div class="pinError" id="pinError">Falscher PIN</div>
  </div>
</div>

<div class="dlgBack" id="dlgBack">
  <div class="dlg" role="dialog" aria-modal="true" aria-labelledby="dlgTitle">
    <div class="dlgTop" id="dlgTitle">Hinweis</div>
    <div class="dlgBody" id="dlgMsg"></div>
    <div class="dlgBtns" id="dlgBtns">
      <button class="dlgBtn" type="button" id="dlgCancel">Abbrechen</button>
      <button class="dlgBtn primary" type="button" id="dlgOk">OK</button>
    </div>
  </div>
</div>

<!-- ===== BOTTOM SHEET (A) ===== -->
<div class="timeSheetBack" id="timeSheetBack">
  <div class="timeSheet" role="dialog" aria-modal="true" aria-labelledby="timeSheetTitle">
    <div class="timeSheetTitle" id="timeSheetTitle">Uhrzeit</div>
    <div id="timeSheetList"></div>
    <div class="timeSheetFooter">
      <button class="timeSheetBtn" type="button" id="timeSheetClose">Abbrechen</button>
    </div>
  </div>
</div>
<input id="nativeTime" type="time" style="position:fixed; left:-9999px; width:1px; height:1px; opacity:0;" />
<!-- =========================== -->

<div class="wrap">

  <div class="topbar">
    <div class="btnrow">
      <button class="primary" id="pdfBtn" type="button">PDF Export</button>
      <button id="prevBtn" type="button">Übersicht</button>
      <button class="send" id="sendBtn" type="button">Senden</button>
      <button class="danger" id="delBtn" type="button">Alles löschen</button>
    </div>
  </div>

  <div class="card">
    <div>
      <label>Name:</label>
      <input id="name" placeholder="Bitte hier deinen Namen eintragen">
      <div class="small" id="nameError" style="display:none; color:var(--danger); font-weight:900;">
        Bitte erst Name eintragen.
      </div>
    </div>

    <div style="margin-top:10px;">
      <label>Monat / Jahr</label>
      <div class="grid2" style="margin-top:6px;">
        <select id="month"></select>
        <select id="year"></select>
      </div>
      <div class="small">Erstellt von Sad</div>
    </div>

    <div class="cardDivider"></div>
  </div>

  <div class="tableCard">
    <div class="tableHeadRow">
      <div class="title">Eintragen</div>
      <div class="hint">↔ nach rechts wischen</div>
    </div>

    <div class="tableScroll">
      <table class="entryTable">
        <thead>
          <tr>
            <th class="colDay">DATUM</th>
            <th class="colKehre">KEHRE</th>
            <th class="colTime">BEGINN</th>
            <th class="colTime">ENDE</th>
            <th class="colStd">STUNDEN</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

  <div class="total">
    Gesamtstunden: <span id="sum">0 Std</span>
  </div>

  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalTop">
        <b id="previewTitle">PDF Vorschau</b>
        <button type="button" id="closePrevTop" style="width:auto; padding:10px 12px;">Schließen</button>
      </div>
      <div class="modalBody">
        <div id="previewTable"></div>
        <div id="previewTotal" class="small" style="margin-top:10px; font-weight:900;"></div>
      </div>
      <div class="modalBtns">
        <button class="primary" type="button" id="exportFromPreview">PDF Export</button>
        <button type="button" id="closePrevBottom">Zurück</button>
      </div>
    </div>
  </div>

  <div id="printArea">
    <div id="printTitle"></div>
    <div id="printMetaTop"></div>

    <table>
      <thead>
        <tr>
          <th style="width:8%;">Datum</th>
          <th style="width:44%;">KEHRE</th>
          <th style="width:16%;">Beginn</th>
          <th style="width:16%;">Ende</th>
          <th class="right" style="width:16%;">Stunden</th>
        </tr>
      </thead>
      <tbody id="printBody"></tbody>
      <tfoot>
        <tr>
          <th colspan="4" class="right">Gesamt</th>
          <th class="right" id="printTotal"></th>
        </tr>
      </tfoot>
    </table>

    <div id="printMetaBottom"></div>
  </div>

</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw3-LIiVd6lG9on22RMTJcMYaMATy2y5Vxm6ep8idY6DWMjc2ThGPTtOHDIutL1pBPVnQ/exec";
const APP_PIN     = "8558";
const PIN_BG_FILE = "nr3.jpg";

const STORAGE_PREFIX = "sad_stundenformular_v10:";

const ORTE = [
  { value: "Niendorf Nord",         short: "Nindorf Nord" },
  { value: "Hagenbecks Tierpark",   short: "Hagensbeck Tierpark" },
  { value: "Farmsen",               short: "Farmsen" },
  { value: "Ochsenzoll",            short: "Ochsenzoll" }
];

const START_CHOICES = ["21:00","22:00","23:00"];
const END_CHOICES   = ["06:00","07:00","08:00"];

const nameEl = document.getElementById("name");
const monthEl = document.getElementById("month");
const yearEl  = document.getElementById("year");
const rowsEl  = document.getElementById("rows");
const sumEl   = document.getElementById("sum");

const nameErrorEl = document.getElementById("nameError");

const pdfBtn  = document.getElementById("pdfBtn");
const prevBtn = document.getElementById("prevBtn");
const sendBtn = document.getElementById("sendBtn");
const delBtn  = document.getElementById("delBtn");

const modalBack = document.getElementById("modalBack");
const previewTitle = document.getElementById("previewTitle");
const previewTable = document.getElementById("previewTable");
const previewTotal = document.getElementById("previewTotal");
const closePrevTop = document.getElementById("closePrevTop");
const closePrevBottom = document.getElementById("closePrevBottom");
const exportFromPreview = document.getElementById("exportFromPreview");

const printTitleEl = document.getElementById("printTitle");
const printMetaTopEl  = document.getElementById("printMetaTop");
const printMetaBottomEl  = document.getElementById("printMetaBottom");
const printBodyEl  = document.getElementById("printBody");
const printTotalEl = document.getElementById("printTotal");

const pinBack = document.getElementById("pinBack");
const pinInput = document.getElementById("pinInput");
const pinBtn = document.getElementById("pinBtn");
const pinError = document.getElementById("pinError");

const dlgBack = document.getElementById("dlgBack");
const dlgTitleEl = document.getElementById("dlgTitle");
const dlgMsgEl = document.getElementById("dlgMsg");
const dlgBtnsEl = document.getElementById("dlgBtns");
const dlgOkBtn = document.getElementById("dlgOk");
const dlgCancelBtn = document.getElementById("dlgCancel");

const timeSheetBack = document.getElementById("timeSheetBack");
const timeSheetTitle = document.getElementById("timeSheetTitle");
const timeSheetList = document.getElementById("timeSheetList");
const timeSheetClose = document.getElementById("timeSheetClose");
const nativeTime = document.getElementById("nativeTime");

let current = new Date(); current.setDate(1);
let dirty = false;
let exported = false;

function pad2(n){ return String(n).padStart(2,"0"); }
function ymKey(d){ return d.getFullYear() + "-" + pad2(d.getMonth()+1); }
function storageKey(){ return STORAGE_PREFIX + ymKey(current); }
function daysInMonth(m,y){ return new Date(y, m, 0).getDate(); }

function markDirty(){
  dirty=true;
  exported=false;
  pdfBtn.disabled=false;
}

function setActiveRow(tr){
  document.querySelectorAll(".trActive").forEach(x=>x.classList.remove("trActive"));
  if(tr) tr.classList.add("trActive");
}

function setNameError(on){
  if(!nameErrorEl) return;
  if(on){
    nameEl.classList.add("inputError");
    nameErrorEl.style.display = "block";
  }else{
    nameEl.classList.remove("inputError");
    nameErrorEl.style.display = "none";
  }
}

function openDialog({ title="Hinweis", message="", mode="confirm", okText="OK", cancelText="Abbrechen" }){
  return new Promise((resolve)=>{
    dlgTitleEl.textContent = title;
    dlgMsgEl.textContent = message;

    if(mode === "alert"){
      dlgBtnsEl.classList.add("one");
      dlgCancelBtn.style.display = "none";
      dlgOkBtn.textContent = okText || "OK";
    }else{
      dlgBtnsEl.classList.remove("one");
      dlgCancelBtn.style.display = "";
      dlgOkBtn.textContent = okText || "OK";
      dlgCancelBtn.textContent = cancelText || "Abbrechen";
    }

    dlgBack.style.display = "block";

    function cleanup(){
      dlgBack.style.display = "none";
      dlgOkBtn.onclick = null;
      dlgCancelBtn.onclick = null;
      dlgBack.onclick = null;
      document.removeEventListener("keydown", onKey);
    }

    function onKey(e){
      if(e.key === "Escape"){
        cleanup();
        resolve(false);
      }
      if(e.key === "Enter"){
        cleanup();
        resolve(true);
      }
    }

    dlgOkBtn.onclick = ()=>{
      cleanup();
      resolve(true);
    };
    dlgCancelBtn.onclick = ()=>{
      cleanup();
      resolve(false);
    };
    dlgBack.onclick = (e)=>{
      if(e.target === dlgBack){
        cleanup();
        resolve(false);
      }
    };

    document.addEventListener("keydown", onKey);
  });
}

function dlgConfirm(message, title="Hinweis"){
  return openDialog({ title, message, mode:"confirm", okText:"OK", cancelText:"Abbrechen" });
}
function dlgAlert(message, title="Hinweis"){
  return openDialog({ title, message, mode:"alert", okText:"OK" });
}

function validateRowsBeforeSend(){
  const errors = [];

  document.querySelectorAll("#rows tr").forEach(tr=>{
    const dateTxt = (tr.querySelector("td")?.textContent || "").trim();
    const ort = (tr.querySelector(".ort")?.value || "").trim();
    const start = (tr.querySelector(".start")?.value || "").trim();
    const end = (tr.querySelector(".end")?.value || "").trim();

    const any = !!(ort || start || end);
    if(!any) return;

    const missing = [];
    if(!ort) missing.push("KEHRE");
    if(!start) missing.push("BEGINN");
    if(!end) missing.push("ENDE");

    if(missing.length){
      errors.push(`• Am ${dateTxt} fehlt ${missing.join(" und ")}.`);
    }
  });

  if(errors.length){
    const msg =
      "Bitte ergänzen:\n\n" +
      errors.slice(0, 12).join("\n") +
      (errors.length > 12 ? `\n\n…und ${errors.length - 12} weitere.` : "");
    return { ok:false, message: msg };
  }

  return { ok:true };
}

function fillMonthYear(){
  monthEl.innerHTML="";
  yearEl.innerHTML="";

  for(let i=1;i<=12;i++){
    const o=document.createElement("option");
    o.value=String(i);
    o.textContent=pad2(i);
    monthEl.appendChild(o);
  }

  const nowY=new Date().getFullYear();
  for(let i=nowY-3;i<=nowY+6;i++){
    const o=document.createElement("option");
    o.value=String(i);
    o.textContent=String(i);
    yearEl.appendChild(o);
  }

  monthEl.value=String(current.getMonth()+1);
  yearEl.value=String(current.getFullYear());
}

function buildOrtOptions(){
  return ORTE.map(o => `<option value="${o.value}" data-short="${o.short}">${o.value}</option>`).join("");
}

function applyShortLabel(selectEl){
  const opt = selectEl.selectedOptions && selectEl.selectedOptions[0];
  if(!opt) return;
  const short = opt.getAttribute("data-short");
  const full = opt.getAttribute("data-full") || opt.textContent;
  opt.setAttribute("data-full", full);
  if(short) opt.textContent = short;
}
function restoreFullLabel(selectEl){
  const opt = selectEl.selectedOptions && selectEl.selectedOptions[0];
  if(!opt) return;
  const full = opt.getAttribute("data-full");
  if(full) opt.textContent = full;
}

let sheetTargetInput = null;
let sheetTargetRow = null;
let sheetMode = "start";

function closeTimeSheet(){
  timeSheetBack.style.display = "none";
  timeSheetList.innerHTML = "";
  sheetTargetInput = null;
  sheetTargetRow = null;
  sheetMode = "start";
}

function openTimeSheet({ title, list, currentValue, targetInput, targetRow, mode }){
  sheetTargetInput = targetInput;
  sheetTargetRow = targetRow;
  sheetMode = mode;

  timeSheetTitle.textContent = title;
  timeSheetList.innerHTML = "";

  const addOpt = (label, value, active, danger)=>{
    const div = document.createElement("div");
    div.className = "timeOpt" + (active ? " active" : "") + (danger ? " dangerOpt" : "");
    div.innerHTML = `<span class="radio"></span><span>${label}</span>`;
    div.addEventListener("click", ()=>{
      if(value === "__OTHER__"){
        nativeTime.value = "";
        nativeTime.onchange = null;
        nativeTime.onchange = ()=>{
          const v = (nativeTime.value || "").trim();
          if(v){
            sheetTargetInput.value = v;
            autoHours(sheetTargetRow);
            markDirty();
            saveState();
          }
          closeTimeSheet();
        };
        nativeTime.click();
        return;
      }

      if(value === "__CLEAR__"){
        sheetTargetInput.value = "";
        autoHours(sheetTargetRow);
        markDirty();
        saveState();
        closeTimeSheet();
        return;
      }

      sheetTargetInput.value = value;
      autoHours(sheetTargetRow);
      markDirty();
      saveState();
      closeTimeSheet();
    });
    timeSheetList.appendChild(div);
  };

  addOpt("Uhrzeit", "__NOOP__", true, false);

  list.forEach(t=>{
    addOpt(t, t, currentValue === t, false);
  });

  addOpt("Andere Uhrzeit", "__OTHER__", false, false);

  addOpt("Zeiten löschen", "__CLEAR__", false, true);

  timeSheetBack.style.display = "block";
}

function build(){
  fillMonthYear();

  const m=parseInt(monthEl.value,10);
  const y=parseInt(yearEl.value,10);
  const days=daysInMonth(m,y);

  rowsEl.innerHTML="";

  for(let d=1; d<=days; d++){
    const tr = document.createElement("tr");
    tr.dataset.day = String(d);

    const shortDate = `${pad2(d)}.${pad2(m)}.${String(current.getFullYear()).slice(-2)}`;

    tr.innerHTML = `
      <td><b>${shortDate}</b></td>

      <td>
        <select class="ort">
          <option value="" selected disabled>Kehre wählen</option>
          ${buildOrtOptions()}
          <option value="__CLEAR_ORT__" class="dangerOpt">Kehre löschen</option>
        </select>
      </td>

      <td>
        <div class="timeField">
          <input type="text" class="start" placeholder="Uhr" readonly>
        </div>
      </td>

      <td>
        <div class="timeField">
          <input type="text" class="end" placeholder="Uhr" readonly>
        </div>
      </td>

      <td>
        <input type="text" class="hours entryHours" placeholder="0" readonly>
      </td>
    `;

    const ort = tr.querySelector(".ort");
    const start = tr.querySelector(".start");
    const end = tr.querySelector(".end");
    const hours = tr.querySelector(".hours");

    function activate(){ setActiveRow(tr); }

    ort.addEventListener("change", ()=>{
      activate();

      if(ort.value === "__CLEAR_ORT__"){
        ort.selectedIndex = 0;
        markDirty();
        saveState();
        return;
      }

      applyShortLabel(ort);
      markDirty();
      saveState();
    });

    ort.addEventListener("focus", ()=>{ activate(); restoreFullLabel(ort); });
    ort.addEventListener("mousedown", ()=>{ restoreFullLabel(ort); });
    ort.addEventListener("blur", ()=>{ applyShortLabel(ort); });

    start.addEventListener("click", ()=>{
      activate();
      openTimeSheet({
        title: "Uhrzeit festlegen",
        list: START_CHOICES,
        currentValue: (start.value || "").trim(),
        targetInput: start,
        targetRow: tr,
        mode: "start"
      });
    });

    end.addEventListener("click", ()=>{
      activate();
      openTimeSheet({
        title: "Uhrzeit festlegen",
        list: END_CHOICES,
        currentValue: (end.value || "").trim(),
        targetInput: end,
        targetRow: tr,
        mode: "end"
      });
    });

    start.addEventListener("focus", activate);
    end.addEventListener("focus", activate);
    hours.addEventListener("focus",(e)=>e.target.blur());

    rowsEl.appendChild(tr);
  }

  loadState();

  document.querySelectorAll(".ort").forEach(sel=>{
    if(sel.value) applyShortLabel(sel);
  });

  updateTotal();

  if(exported && !dirty) pdfBtn.disabled=true;
}

function applyMonthAuto(){
  const mm=parseInt(monthEl.value,10);
  const yy=parseInt(yearEl.value,10);
  current=new Date(yy, mm-1, 1);
  dirty=false;
  exported=false;
  build();
}

function timeToMinutes(t){
  if(!t) return null;
  const m=t.match(/^(\d{2}):(\d{2})$/);
  if(!m) return null;
  return parseInt(m[1],10)*60 + parseInt(m[2],10);
}

function formatHoursSmart(hours){
  if(hours == null || isNaN(hours)) return "";
  const rounded = Math.round(hours * 100) / 100;
  return Number.isInteger(rounded) ? rounded.toString() : rounded.toString();
}
function formatHoursWithStd(hours){
  const v = formatHoursSmart(hours);
  return v ? (v + " Std") : "";
}

function autoHours(row){
  const s=timeToMinutes(row.querySelector(".start").value);
  const e=timeToMinutes(row.querySelector(".end").value);
  const out=row.querySelector(".hours");

  if(s==null || e==null){
    out.value="";
    updateTotal();
    return;
  }
  let diff=e-s;
  if(diff<0) diff+=1440;
  const hours = diff/60;

  out.value = formatHoursSmart(hours);
  updateTotal();
}

function parseHoursFromField(v){
  if(!v) return NaN;
  const m = String(v).replace(",",".").match(/(\d+(\.\d+)?)/);
  return m ? parseFloat(m[1]) : NaN;
}

function updateTotal(){
  let sum=0;
  document.querySelectorAll(".hours").forEach(i=>{
    const v=parseHoursFromField(i.value);
    if(!isNaN(v)) sum+=v;
  });
  sumEl.textContent = formatHoursWithStd(sum) || "0 Std";
}

function getState(){
  const rows=[];
  document.querySelectorAll("#rows tr").forEach(r=>{
    rows.push({
      day: pad2(r.dataset.day),
      ort: r.querySelector(".ort").value||"",
      start: r.querySelector(".start").value||"",
      end: r.querySelector(".end").value||"",
      hours: r.querySelector(".hours").value||""
    });
  });
  return {
    name: nameEl.value||"",
    monthKey: ymKey(current),
    month: pad2(current.getMonth()+1),
    year: String(current.getFullYear()),
    rows,
    total: sumEl.textContent || "",
    dirty,
    exported
  };
}

function saveState(){
  localStorage.setItem(storageKey(), JSON.stringify(getState()));
}

function loadState(){
  const raw=localStorage.getItem(storageKey());
  if(!raw){ saveState(); return; }

  try{
    const st=JSON.parse(raw);
    nameEl.value=st.name||"";

    const rowEls=document.querySelectorAll("#rows tr");
    (st.rows||[]).forEach((r, idx)=>{
      if(!rowEls[idx]) return;

      const ortSel=rowEls[idx].querySelector(".ort");
      if(r.ort && r.ort !== "__CLEAR_ORT__") ortSel.value=r.ort;
      else ortSel.selectedIndex=0;

      rowEls[idx].querySelector(".start").value=r.start||"";
      rowEls[idx].querySelector(".end").value=r.end||"";
      rowEls[idx].querySelector(".hours").value=r.hours||"";
    });

    dirty=!!st.dirty;
    exported=!!st.exported;
  }catch(e){
    saveState();
  }
}

function buildPrintTable(){
  const name=(nameEl.value||"").trim();
  const mm=pad2(current.getMonth()+1);
  const yy=current.getFullYear();

  printTitleEl.textContent=`Stundenformular – ${mm}/${yy}`+(name?` – ${name}`:"");
  printMetaTopEl.textContent=`Erstellt von Sad`;

  printBodyEl.innerHTML="";
  let sum=0;

  document.querySelectorAll("#rows tr").forEach(r=>{
    const day=pad2(r.dataset.day);
    const ort=r.querySelector(".ort").value||"";
    const start=r.querySelector(".start").value||"";
    const end=r.querySelector(".end").value||"";
    const hrsTxt=r.querySelector(".hours").value||"";
    const empty=!ort&&!start&&!end&&!hrsTxt;

    const tr=document.createElement("tr");
    if(empty) tr.className="empty";

    const hrsNum = parseHoursFromField(hrsTxt);
    if(!isNaN(hrsNum)) sum+=hrsNum;

    tr.innerHTML=`
      <td>${day}</td>
      <td>${ort === "__CLEAR_ORT__" ? "" : ort}</td>
      <td>${start}</td>
      <td>${end}</td>
      <td class="right">${hrsTxt}</td>
    `;
    printBodyEl.appendChild(tr);
  });

  printTotalEl.textContent = formatHoursWithStd(sum);
  printMetaBottomEl.textContent = `Gesamtstunden: ${formatHoursWithStd(sum)}`;
}

function exportPDF(){
  buildPrintTable();
  exported=true;
  dirty=false;
  pdfBtn.disabled=true;
  saveState();
  window.print();
}

async function allesLoeschen(){
  const ok = await dlgConfirm("Wirklich ALLES für diesen Monat löschen?", "Bestätigung");
  if(!ok) return;
  localStorage.removeItem(storageKey());
  dirty=false;
  exported=false;
  build();
}

function openPreview(){
  const name=(nameEl.value||"").trim();
  const mm=pad2(current.getMonth()+1);
  const yy=current.getFullYear();

  previewTitle.textContent=`PDF Vorschau – ${mm}/${yy}`+(name?` – ${name}`:"");

  let sum=0;
  const parts=[];
  parts.push(`
    <table style="width:100%; border-collapse:collapse; table-layout:fixed; font-size:12px;">
      <thead>
        <tr style="background:linear-gradient(90deg, rgba(79,70,229,.12), rgba(6,182,212,.10));">
          <th style="border:1px solid #ddd; padding:8px; width:10%;">Tag</th>
          <th style="border:1px solid #ddd; padding:8px; width:42%;">KEHRE</th>
          <th style="border:1px solid #ddd; padding:8px; width:16%;">Beginn</th>
          <th style="border:1px solid #ddd; padding:8px; width:16%;">Ende</th>
          <th style="border:1px solid #ddd; padding:8px; width:16%; text-align:right;">Stunden</th>
        </tr>
      </thead>
      <tbody>
  `);

  document.querySelectorAll("#rows tr").forEach(r=>{
    const day=pad2(r.dataset.day);
    const ort=r.querySelector(".ort").value||"";
    const start=r.querySelector(".start").value||"";
    const end=r.querySelector(".end").value||"";
    const hrs=r.querySelector(".hours").value||"";
    const empty=!ort&&!start&&!end&&!hrs;

    const v = parseHoursFromField(hrs);
    if(!isNaN(v)) sum+=v;

    parts.push(`
      <tr style="${empty ? "background:#f3f4f6;" : ""}">
        <td style="border:1px solid #ddd; padding:8px; white-space:nowrap;">${day}</td>
        <td style="border:1px solid #ddd; padding:8px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${ort === "__CLEAR_ORT__" ? "" : ort}</td>
        <td style="border:1px solid #ddd; padding:8px; white-space:nowrap;">${start}</td>
        <td style="border:1px solid #ddd; padding:8px; white-space:nowrap;">${end}</td>
        <td style="border:1px solid #ddd; padding:8px; text-align:right; white-space:nowrap; font-weight:900;">${hrs}</td>
      </tr>
    `);
  });

  parts.push(`</tbody></table>`);
  previewTable.innerHTML=parts.join("");
  previewTotal.textContent = `Gesamtstunden: ${formatHoursWithStd(sum)}`;
  modalBack.style.display="block";
}
function closePreview(){ modalBack.style.display="none"; }

async function senden(){
  const nm = (nameEl.value || "").trim();
  if(!nm){
    setNameError(true);
    nameEl.focus();
    return;
  }

  const vres = validateRowsBeforeSend();
  if(!vres.ok){
    await dlgAlert(vres.message, "Bitte prüfen");
    return;
  }

  const ok = await dlgConfirm(
    "Hinweis: Bitte sende nur EINMAL im Monat deine Stunden (nicht täglich). Jetzt senden?",
    "Senden bestätigen"
  );
  if(!ok) return;

  if(!WEB_APP_URL || WEB_APP_URL.includes("HIER_DEIN_EXEC_LINK") || WEB_APP_URL === "leerlassen"){
    await dlgAlert("Bitte erst den WEB_APP_URL (exec Link) im Code eintragen.", "Fehler");
    return;
  }

  const payload = getState();

  sendBtn.disabled = true;
  const oldText = sendBtn.textContent;
  sendBtn.textContent = "Sende...";

  try{
    const res = await fetch(WEB_APP_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });

    if(!res.ok) throw new Error("HTTP " + res.status);

    await dlgAlert("Gesendet ✅", "Erfolg");
  }catch(err){
    console.error(err);
    await dlgAlert("Fehler: Failed to fetch", "Fehler");
  }finally{
    sendBtn.disabled = false;
    sendBtn.textContent = oldText;
  }
}

function requirePin(){
  if(!APP_PIN || APP_PIN.trim()==="") return;

  const ok = sessionStorage.getItem("sad_pin_ok")==="1";
  if(ok) return;

  pinBack.style.display="flex";
  setTimeout(()=>pinInput.focus(), 50);

  function check(){
    const val=(pinInput.value||"").trim();
    if(val === APP_PIN){
      sessionStorage.setItem("sad_pin_ok","1");
      pinBack.style.display="none";
      pinError.style.display="none";
      pinInput.value="";
    }else{
      pinError.style.display="block";
    }
  }

  pinBtn.onclick = check;
  pinInput.addEventListener("keydown",(e)=>{
    if(e.key==="Enter") check();
  });
}

pdfBtn.addEventListener("click", exportPDF);
prevBtn.addEventListener("click", openPreview);
sendBtn.addEventListener("click", senden);
delBtn.addEventListener("click", allesLoeschen);

closePrevTop.addEventListener("click", closePreview);
closePrevBottom.addEventListener("click", closePreview);
exportFromPreview.addEventListener("click", exportPDF);

modalBack.addEventListener("click",(e)=>{ if(e.target===modalBack) closePreview(); });

monthEl.addEventListener("change", applyMonthAuto);
yearEl.addEventListener("change", applyMonthAuto);

nameEl.addEventListener("input", ()=>{
  setNameError(false);
  markDirty();
  saveState();
});

timeSheetClose.addEventListener("click", closeTimeSheet);
timeSheetBack.addEventListener("click",(e)=>{ if(e.target===timeSheetBack) closeTimeSheet(); });

(function init(){
  if(PIN_BG_FILE && PIN_BG_FILE.trim() !== ""){
    document.documentElement.style.setProperty("--pinBg", `url("${PIN_BG_FILE}")`);
  }else{
    document.documentElement.style.setProperty("--pinBg", "none");
  }

  fillMonthYear();
  build();
  requirePin();
})();
</script>
</body>
</html>
